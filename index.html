<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da velha</title>
    <style>
        #screen{
            border: 1px solid violet;
        }
    </style>
</head>
<body>
    <canvas id="screen" width="500" height="500"></canvas>
    <script type="module">
        import createInputListener from "./mouse-listener.js"

        const screen = document.getElementById("screen");
        const context = screen.getContext("2d");
        
        const SCREEN_OFFSET = {x: screen.offsetLeft, y: screen.offsetTop}

        const HEIGHT = 500;
        const WIDTH  = 500;

        const game = createGame()
        const state = game.state
        const mouseListerner = createInputListener(game.state.screen)
        
        mouseListerner.subscribe(game.movePlayer)

        function createGame (){

            const state = {
                table: [[ "player2", "", "" ],
                        [ "", "player2", "" ],
                        [ "", "", "player2" ]],
                
                players: {
                    "player1" : {score: 0, color: "red"},
                    "player2" : {score: 0, color: "blue"}
                },

                screen: {width: 3, height: 3},

                currentPlayer: "player1"
            }

            function movePlayer (command) {
                const table = state.table
                const move = command.move

                if (state.currentPlayer === command.player){
                    if (table[move.y][move.x] == ""){
                        table[move.y][move.x] = command.player
                        console.log(`WINNER? -> ${verifyVictory()}`)
                        updateCurrentPlayer(state.currentPlayer)
                    }    
                }
            }

            function updateCurrentPlayer(currentPlayer){
                for (const player in state.players){
                    if ( player != currentPlayer ) 
                        state.currentPlayer = player       
                }
            }

            //Pode ser melhorado
            //verificar apenas a linha do movimento e nao todos os elementos

            function verifyVictory (){
                const table = state.table
                for (let i = 0; i < state.screen.height; i++){
                    if (table[i][0] == table[i][1] && table[i][1] == table[i][2] && table[i][0] != "")
                        return true
                    
                }
                for (let i = 0; i < state.screen.width; i++){
                    if (table[0][i] == table[1][i] && table[1][i] == table[2][i]  && table[0][i] != "")
                        return true
                    
                }

                if (table[0][0] == table[1][1] && table[1][1] == table[2][2]  && table[0][0] != ""){
                    return true
                }

                if (table[2][0] == table[1][1] && table[1][1] == table[0][2]  && table[2][0] != ""){
                    return true
                }
            }

            return {
                state, 
                movePlayer,
                updateCurrentPlayer
            }
        }

        renderScreen()

        function renderScreen() {
            for (let i = 0; i < state.screen.height; i++){
                for (let j = 0; j < state.screen.width; j++){
                    const cell = state.table[i][j]
                    const player = state.players[cell]
                    
                    if ( player ){
                        const w = WIDTH / state.screen.width
                        const h = HEIGHT / state.screen.height

                        context.fillStyle = player.color
                        context.fillRect(j*w, i*h, w, h)
                    }   
                }
            }

            requestAnimationFrame(renderScreen)
        }
        
    

    </script>
</body>
</html>
